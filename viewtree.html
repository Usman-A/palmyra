<!DOCTYPE html>
<!--
Palmyra
Copyright (c) 2019 New York University Abu Dhabi

License: MIT BSD-3

THIS SOFTWARE IS PROVIDED ''AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
IN NO EVENT SHALL THE U.S. GOVERNMENT OR ANY DEPARTMENTS OR EMPLOYEES THEREOF BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.)
-->
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="main.css">
    <link rel="stylesheet" type="text/css" href="text_upload.css">
    <title>Palmyra v3.0</title>
</head>

<body class="viewtree">

    <!-- Loading overlay -->
    <div id="loadingOverlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-family: Arial, sans-serif;
    ">
        <div style="text-align: center;">
            <h2 style="margin-bottom: 20px; color: #333;">Configuring Editor...</h2>
            <div class="spinner" style="
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto;
            "></div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <div class="navbar">
        <div class="container" style="display: flex; flex-direction: row; justify-content: space-between; height: 65px">
            <div class="logo" style="float: left">
                <a href="index.html"><img src="fonts/logo.png" alt="palmyra" id='logo'/></a>
            </div>
            <div class="toolbar" style="display: flex;flex-direction: column;margin-left: 20px;height: 65px">
                <div id="conlluFileNameDiv" class="file-name-tree-number">
                    <span id="conlluFileName"></span>
                    <span id="currentTreeNumber" class="tab parens"></span>
                </div>
                <div class="toolbar btn-options" align="left" style="display: flex;justify-content: flex-start;align-items: center;">
                    <div class="dropdown">
                        <button class="dropbtn">Edit
                          <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="dropdown-content">
                          <p onClick="editToggle()">Edit Morphology (ctrl + shift + m)</p>
                          <p onClick="tagsToggle()">Edit Tags (ctrl + shift + t)</p>
                          <p onClick="addNewTree()">Add New Tree</p>
                          <p onClick="deleteCurrentTree()">Delete Current Tree</p>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="dropbtn">View
                          <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="dropdown-content">
                          <p onClick="directionToggle()">Change Direction<p>
                          <p onClick="search(treesArray)">Listing (ctrl + shift + l)</p>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="dropbtn">Go
                          <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="dropdown-content">
                          <p onClick="firstTree()">First tree (ctrl + shift + &#8593;)<p>
                          <p onClick="prevTree()">Previous tree (ctrl + shift + &#8592;)</p>
                          <p onClick="nextTree()">Next tree (ctrl + shift + &#8594;)</p>
                          <p onClick="lastTree()">Last tree (ctrl + shift + &#8595;)</p>
                          <p onClick="goToTreeToggle()">Search by tree number</p>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="dropbtn">Help
                          <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="dropdown-content">
                            <p><a href="about.html" target="_blank" style="color:black">About</a></p>
                            <!-- <p><a href="terms_of_use.html" target="_blank" style="color:black">Terms of use</a></p> -->
                            <p><a href="privacy_policy.html" target="_blank" style="color:black">Privacy Policy</a></p>
                        </div>

                    </div>
                    <!-- <div class="dropdown">
                        <button class="dropbtn">Help
                          <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="dropdown-content">
                        </div>
                    </div> -->
                </div>
            </div>
            
            <!-- Right side submit section -->
            <div id="submit-section" style="display: flex; align-items: center; gap: 10px; margin-right: 20px;">
                <label for="editor-password" style="color: #FFFFFF; font-size: 14px;">Editor Password:</label>
                <input type="password" id="editor-password" placeholder="Password" style="padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                <button id="submit-btn" onclick="handleSubmitAnnotation()" style="padding: 5px 15px; background-color: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">Submit</button>
            </div>
            
            <!-- <div class="btn btn-open" id="parseButton"> -->
        </div>

        <div class="container" style="width:100%">
        <section id="upload3" class="upload" >
            <p>Config File:</p>
            <select id="configFileSelector">
                <option selected>conllu_config.cfg (Local)</option>
            </select>
            <input style="float:left; display:none" type="file" name="configFile" id="configFile"/>
        </section>
        </div>

        <!-- upload a conll file from device -->
        <div class="container" style="width:100%">
            <section id="upload" class="upload">
                <p>Select CoNLL-U File:</p>
                <input style="float:left" type="file" id="inputFile" name="treefiles[]" /><br>
                <input style="float:right; margin-right:45px" type="button" id="treebtn" value="Upload"
                    onClick="setupTreePage(PayloadDataChecker)" />
                <!-- <input style="float:right" type="button" id="treebtn" value="Upload" onClick="setJSONtreeData()" /> -->
            </section>
        </div>


        <div id="auth_logout_btns" class="toolbar" style="text-align: center;">
            <input type="button" value="Authenticate with Google Drive" id="auth_btn"
                onClick="authenticate()"/>
            <input type="button" tabindex="-1" value="Logout" id="logout_btn" onClick="logout()" />
        </div>

        <section id="download-section" class="section-alignment">
            <form id="download">
                <p>File Name</p>
                <input type="text" id="filename" />
            </form>
            <input type="button" id="dwnbtn" value="Download" onClick="downloadTree()" />
            <button onClick="hideAllWindows()">Close</button>
        </section>

        <section id="rename-section" class="section-alignment">
            <form id="rename">
                <p>File Name</p>
                <input type="text" id="filename_remote" />
            </form>
            <input type="button" id="rename_btn" value="Save" onClick="saveTreeRemote();hideAllWindows()" />
            <button onClick="hideAllWindows()">Close</button>
        </section>

        <section id="gototree-section" class="section-alignment">
            <form id="gototree">
                <p>Please select tree number:</p>
                <input type="number" id="treeNumberInput" min="1" max="1" style="width: 3em">
            </form><br>
            <input type="button" id="goTreebtn" value="Go" onClick="goToTree()" />
            <button onClick="cancelGoToTree()">Close</button>
        </section>

        <section id='labels'>
            <label class='labelsp'>Relation Labels</label>

        </section>

        <section id='postags'>
            <label class='labelsp'>POS Tags</label>

        </section>

        <div id="listing" class="scroll" style="width:50%;height:400px;">
            <section id="search" style="display:block; width: 90%;"></section>
        </div>


        <section id='morphology'>
            <p class='labelsp'>Token:</p>
            <div>
                <input type="text" id="morphologyName"><br>
            </div>

            <div id='lemmaField'>
            </div>

            <div id='lexicalFeats'>
            </div>

            <p class='labelsp' id='labelspMorphoFeats'>Morphological Features:</p>
            <div id='morphoFeats'>
            </div>
            <p>
                <button onClick="saveMorphology()">OK</button>
                <button onClick="cancelMorphology()">Cancel</button>
            </p>
        </section>

    </div>

    <div id="sents" class="standard">
        <p id="fullSentence"></p>
        <p id="print"></p>
        <hr>
    </div>


    <script src="scripts/jquery-1.11.3.min.js"></script>
    <script src="scripts/d3.v3.min.js"></script>
    <!-- <script src="scripts/Blob.js"></script> -->
    <script src="scripts/FileSaver.min.js"></script>
    <script src="scripts/saveSvgAsPng.js"></script>
    <script src="scripts/underscore-min.js"></script>
    <script src="scripts/cycle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script src="configFileHandler.js"></script>
    <script src="gapiLoader.js"></script>
    <script src="authenticator.js"></script>
    <script src="parsing.js"></script>

    <script async defer src="https://apis.google.com/js/api.js"
        onload="gapiLoaded('client', initializeGapiClient)"></script>
    <script async defer src="https://apis.google.com/js/api.js"
        onload="gapiLoaded('picker', initializeGapiPicker)"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script src="main.js"></script>
    <script src="keyboardShortcuts.js"></script>
    

    <script>
        let configLoaded = false;
        let conlluDataReceived = false;
        let receivedConlluData = null;
        let configData = null;

        // Declare these at the top level, outside any function
        let chapterNumber = null;
        let sectionId = null;
        let editorId = null;

        // Auto-load fixed config filew
        window.addEventListener('load', function() {
            // Load the fixed config file
            fetch('palmyra/conllu_config.cfg')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load config file');
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Fixed config file loaded');
                    configData = data;
                    
                    // Store the config data but don't parse yet
                    // We'll parse it when needed in the checkAndAutoParse function
                    configLoaded = true;
                    checkAndAutoParse();
                })
                .catch(error => {
                    console.error('Error loading config file:', error);
                    // Try to proceed without config
                    configLoaded = true;
                    checkAndAutoParse();
                });
        });

        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            console.log('Received message from parent:', event.data);
            
            if (event.data && event.data.conlluData) {
                receivedConlluData = event.data.conlluData;
                const payload = event.data;
                
                // Assign values here
                chapterNumber = payload.chapterNumber;
                sectionId = payload.sectionId;
                editorId = payload.editorId;
                
                console.log('Processing ConLLU data for:', {
                    chapter: payload.chapterNumber,
                    section: payload.sectionId,
                    editor: payload.editorId
                });
                
                // Load the ConLLU data into textarea
                const textarea = document.getElementById('treedata2');
                if (textarea) {
                    textarea.value = receivedConlluData;
                    console.log('ConLLU data loaded into textarea');
                }
                
                conlluDataReceived = true;
                checkAndAutoParse();
            }
        });

        // Check if both config and data are ready, then auto-parse
        function checkAndAutoParse() {
            if (configLoaded && conlluDataReceived) {
                console.log('Both config and ConLLU data loaded, auto-parsing...');
                
                // First ensure config is properly loaded
                if (configData && typeof parseConfig === 'function') {
                    try {
                        // Create a file object from the config data
                        let configFile = new File([configData], "conllu_config.cfg", { type: "text/plain" });
                        defaultConfigFiles = [configFile];
                        
                        // Parse the config
                        parseConfig(configData);
                        configRead = true;
                        console.log('Config parsed successfully');
                    } catch (e) {
                        console.error('Error parsing config:', e);
                    }
                }
                
                // Wait a bit to ensure DOM is ready and config is processed
                setTimeout(() => {
                    try {
                        console.log('Auto-calling setupTreePage with PayloadDataChecker...');
                        if (typeof window.setupTreePage === 'function') {
                            window.setupTreePage(window.PayloadDataChecker);
                        } else {
                            // Try calling it from global scope
                            setupTreePage(PayloadDataChecker);
                        }
                        
                        // Hide loading screen after setup is complete
                        setTimeout(() => {
                            const loadingOverlay = document.getElementById('loadingOverlay');
                            if (loadingOverlay) {
                                loadingOverlay.style.display = 'none';
                            }
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error during auto-parsing:', error);
                        
                        // Hide loading screen even on error
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'none';
                        }
                    }
                }, 1000); // Wait for scripts to load
            }
        }
        
        // Function to check and return payload data instead of file input
        window.PayloadDataChecker = function() {
            if (!receivedConlluData) {
                alert("No ConLL-U data available from payload. Please ensure data is passed correctly.");
                return null;
            }
            
            // Create a mock file object from the payload data
            const blob = new Blob([receivedConlluData], { type: 'text/plain' });
            const file = new File([blob], 'payload_data.conllu', { type: 'text/plain' });
            
            isConlluLocal = true;
            return file;
        };

        // Submit annotation handler with confirmation
        let submitConfirmationPending = false;
        window.handleSubmitAnnotation = function() {
            const submitButton = document.getElementById('submit-btn');
            const passwordField = document.getElementById('editor-password');
            
            if (!submitConfirmationPending) {
                // Validate password first
                if (!passwordField.value.trim()) {
                    alert('Please enter the editor password');
                    return;
                }
                
                // First press - show confirmation
                submitButton.textContent = 'Confirm Submit?';
                submitButton.style.backgroundColor = '#e74c3c';
                submitConfirmationPending = true;
                
                // Reset after 5 seconds if not confirmed
                setTimeout(() => {
                    if (submitConfirmationPending) {
                        submitButton.textContent = 'Submit';
                        submitButton.style.backgroundColor = '#3498db';
                        submitConfirmationPending = false;
                    }
                }, 5000);
            } else {
                // Second press - confirmed, call endpoint
                submitButton.textContent = 'Submitting...';
                submitButton.style.backgroundColor = '#27ae60';
                
                // Call the endpoint
                submitAnnotationToEndpoint();
                
                // Reset state
                submitConfirmationPending = false;
            }
        };

        // Function to submit annotation to endpoint
        async function submitAnnotationToEndpoint() {
            try {
                // Get ConLL-U data as string using the same logic as download
                const conlluString = convertTreesArrayToString();
                const password = document.getElementById('editor-password').value;
                
                const payload = {
                    annotationData: conlluString,
                    chapter: chapterNumber,
                    section: sectionId,
                    editor: editorId,
                    editorPassword: password,
                };

                const response = await fetch('/api/submit-annotation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // Show success screen
                    showSuccessScreen();
                } else {
                    const submitButton = document.getElementById('submit-btn');
                    submitButton.textContent = 'Submit Failed';
                    submitButton.style.backgroundColor = '#e74c3c';
                    console.error('Failed to submit annotation');
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        submitButton.textContent = 'Submit';
                        submitButton.style.backgroundColor = '#3498db';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error submitting annotation:', error);
                const submitButton = document.getElementById('submit-btn');
                submitButton.textContent = 'Submit Error';
                submitButton.style.backgroundColor = '#e74c3c';
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    submitButton.textContent = 'Submit';
                    submitButton.style.backgroundColor = '#3498db';
                }, 3000);
            }
        }

        // Show success screen after successful submission
        function showSuccessScreen() {
            // Hide all content except navbar
            document.body.innerHTML = `
                <div class="navbar">
                    <div class="container" style="display: flex; flex-direction: row; justify-content: center; height: 65px; align-items: center;">
                        <div class="logo">
                            <a href="index.html"><img src="fonts/logo.png" alt="palmyra" id='logo'/></a>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 80vh; text-align: center; font-family: Arial, sans-serif;">
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 30px; border-radius: 10px; margin-bottom: 20px;">
                        <h2 style="margin: 0 0 15px 0;">âœ… Success!</h2>
                        <p style="margin: 0; font-size: 16px;">Your annotation has been submitted successfully.</p>
                    </div>
                    
                    <div style="display: flex; gap: 15px;">
                        <button onclick="window.close()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            Close Editor
                        </button>
                    </div>
                </div>
            `;
        }
    </script>

</body>

</html>